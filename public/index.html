<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Проверка презентаций</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --background-color: #333;
            --foreground-color: #fff;
            --subtle-color: #666;

            --header-height: 50px;
            --border-radius: 5px;

            --box-shadow: inset 0 0 1px 1px #ffffff09, 1px 1px 3px 0 #0004;
        }
        html, body {
            height: 100%;
            background-color: var(--background-color);
            color: var(--foreground-color);
            font-family: sans-serif;
        }
        body {
            max-width: 700px;
            margin: 0 auto;
            box-sizing: border-box;
            padding: 10px 5px;
        }
        #header {
            height: var(--header-height);
            display: flex;
            align-items: center;
        }
        #user-controls {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #new-presentation-downloading-area {
            border: 2px dashed var(--subtle-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: center;
            padding: 70px 0;
            margin: 30px 0;
        }

        button {
            border: 2px solid var(--subtle-color);
            background-color: transparent;
            padding: 5px 10px;
            color: inherit;
            font: inherit;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin: 5px;
        }
        .error-message {
            color: red;
        }
        .sign-in-out-form, .report, .checks {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 0 0;
            gap: 10px;
        }
        .checks {
            padding-top: 20px;
            gap: 18px;
        }
        input {
            font: inherit;
            color: inherit;
            background-color: transparent;
            border: none;
            filter: none;
            padding: 5px 10px;
        }
        .sign-in-out-input {
            text-align: center;
        }
        #logo {
            cursor: pointer;
            padding: 5px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .banner {
            text-align: center;
            padding: 50px 0;
        }
        .check {
            display: flex;
            align-items: center;
            gap: 7px;
        }
        .success-sign, .fail-sign {
            width: 1rem;
            height: 1rem;
            background-color: grey;
            border-radius: 100rem;
            position: relative;
            --sign-line-width: 3px;
            box-shadow: var(--box-shadow);
        }
        .success-sign::after, .fail-sign::after, .fail-sign::before {
            position: absolute;
            content: "";

            border: solid var(--background-color);
            border-width: 0;
            border-bottom-width: var(--sign-line-width);
        }
        .success-sign::after {
            border-right-width: var(--sign-line-width);
        }
        .success-sign {
            background-color: #0F0;
        }
        .fail-sign {
            background-color: #F00;
        }
        .success-sign::after {
            width: 23%;
            height: 48%;
            left: 51%;
            top: 42%;
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .fail-sign::after, .fail-sign::before {
            width: 70%;
            left: 15%;
            height: 0;
            top: calc(50% - var(--sign-line-width) / 2);
            transform-origin: center calc(var(--sign-line-width) / 2);
            transform: rotate(45deg);
        }
        .fail-sign::before {
            transform: rotate(-45deg);
        }
        samp, .fragment {
            font: inherit;
            /*font-family: monospace;*/
            background-color: #fff1;
            border-radius: var(--border-radius);
            padding: 4px 8px;
            box-shadow: var(--box-shadow);
        }
        input, button {
            outline: none;
        }
        /*a {*/
        /*    color: inherit;*/
        /*}*/
        h2 {
            font: inherit;
            font-size: 1.2rem;
            text-align: center;
            margin: 40px 0 20px;
            padding: 0;
        }
        .report-link {
            display: flex;
            padding: 11px;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #fff1;
        }
        .report-link:last-child {
            border: none;
        }
        .report-link > :last-child {
            margin-left: auto;
        }
    </style>
    <script type="module">
        let $ = document.querySelector.bind(document);

        import { h, Component, render, createContext } from 'https://unpkg.com/preact@latest?module';
        import { useContext } from 'https://unpkg.com/preact@latest/hooks/dist/hooks.module.js?module';
        import htm from 'https://unpkg.com/htm?module';

        const html = htm.bind(h); // Initialize htm with Preact

        function post(url, json) {
            if (localStorage.authToken)
                json.authToken = localStorage.authToken
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(json),
            })
                .then(response => {
                    if (response.ok)
                        return response.json();
                    else
                        return null;
                })
                .catch(console.error)
        }

        function get(url) {
            let headers = {};
            if (localStorage.authToken)
                headers['Authorization'] = 'Bearer ' + localStorage.authToken;
            return fetch(url, {
                headers,
            })
            .then(response => {
                if (response.ok)
                    return response.json();
                else
                    return null;
            })
            .catch(console.error)
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                let result = reader.result;
                resolve(result.substring(result.indexOf(",") + 1));
            }
            reader.onerror = error => reject(error);
        });

        const AppContext = createContext(null);

        function UserControls(props) {
            const app = useContext(AppContext).app;

            if (!props.userName) {
                return html`
                    <div id="user-controls">
                        <button id="login-link" onClick=${() => app.relocate('/sign-in')}>Войти
                        </button><button onClick=${() => app.relocate('/sign-up')}>Регистрация</button>
                    </div>
                `;
            }
            else {
                return html`
                    <div id="user-controls">
                        ${props.userName} <button onClick=${() => app.sighOut()}>Выйти</button>
                    </div>
                `;
            }
        }

        class ReportsList extends Component {
            render() {
                let app = useContext(AppContext).app;

                if (!app.isSignIn())
                    return html``;
                if (!app.state.reports) {
                    app.fetchReports();
                    return html``;
                }
                return html`
                    <h2>Прошлые проверки</h2>
                    ${
                        app.state.reports.map(report => html`
                            <div class="report-link" onclick=${() => app.relocate("/report/" + report.id)}>
                                <div>${report.fileName}</div>
                                <div>${new Date(report.datetime).toLocaleString()}</div>
                            </div>
                        `)
                    }
                `;
            }
        }

        class MainPageContent extends Component {
            constructor(props) {
                super(props);
            }

            _uploadPresentationForChecking(file, /*TODO*/) {
                if (!file)
                    return;

                toBase64(file).then(presentation => {
                    post("/api/check-presentation", {
                        presentation,
                        fileName: file.name,
                    })
                    .then(response => {
                        if (!response || !response.success)
                            return;
                        this._app.relocate('/report/' + response.reportId);
                        this._app.fetchReports(); // TODO
                    })
                })
                .catch(console.error);
            }

            _openPresentationChoosingDialog() {
                let fileInput = document.createElement("input");
                fileInput.type = "file";
                fileInput.accept = ".pptx";
                fileInput.click();

                fileInput.onchange = () => {
                    let file = fileInput.files[0];
                    this._uploadPresentationForChecking(file);
                };
            }

            render() {
                this._app = useContext(AppContext).app;
                return html`
                    <div id="new-presentation-downloading-area"
                        onclick=${this._openPresentationChoosingDialog.bind(this)}
                        ondrop=${event => {event.preventDefault();
                            this._uploadPresentationForChecking(event.dataTransfer.files[0])}}
                        ondragover=${event => {event.preventDefault(); event.dataTransfer.dropEffect = "move";}}
                    >Перетащи презентацию или кликни меня чтобы выбрать её</div>
                    <${ReportsList} />
                `;
            }
        }

        class SignInPage extends Component {
            constructor(props) {
                super(props);
                this.state = {
                    message: '',
                };
            }

            requestSignIn(login, password) {
                post("/api/sign-in", {login, password})
                .then(result => {
                    if (!result)
                        return;

                    if (result.success) {
                        this._app.rememberSignIn(login, result.token);
                        this._app.relocate('/');
                    }
                    else
                        this.setState({message: result.message});
                });
            }

            onSubmit(submitEvent) {
                submitEvent.preventDefault();
                this.requestSignIn(this.state.login, this.state.password);
            }

            render() {
                this._app = useContext(AppContext).app;

                return html`
                <form class="sign-in-out-form" onSubmit=${this.onSubmit.bind(this)}>
                    <input class="sign-in-out-input" placeholder="Логин" autocomplete="username"
                        onChange=${event => this.setState({login: event.target.value})} />
                    <input class="sign-in-out-input" placeholder="Пароль" type="password" autocomplete="current-password"
                        onChange=${event => this.setState({password: event.target.value})} />
                    <div class="error-message">${this.state.message}</div>
                    <button>Войти</button>
                </form>
            `;
            }
        }

        class SignUpPage extends Component {
            constructor(props) {
                super(props);
                this.state = {
                    message: '',
                };
            }

            requestSignUp(login, password, passwordAgain) {
                if (password !== passwordAgain) {
                    this.setState({message: "Пароли не совпадают"});
                    return;
                }
                post("/api/sign-up", {login, password})
                .then(result => {
                    if (!result)
                        return;

                    if (result.success) {
                        this._app.rememberSignIn(login, result.token);
                        this._app.relocate('/');
                    }
                    else
                        this.setState({message: result.message});
                });
            }

            onSubmit(submitEvent) {
                submitEvent.preventDefault();
                this.requestSignUp(this.state.login, this.state.password, this.state.passwordAgain);
            }

            render() {
                this._app = useContext(AppContext).app;

                return html`
                <form class="sign-in-out-form" onSubmit=${this.onSubmit.bind(this)}>
                    <input class="sign-in-out-input" placeholder="Логин" autocomplete="username"
                        onChange=${event => this.setState({login: event.target.value})} />
                    <input class="sign-in-out-input" placeholder="Пароль" type="password" autocomplete="new-password"
                        onChange=${event => this.setState({password: event.target.value})} />
                    <input class="sign-in-out-input" placeholder="Пароль еще раз" type="password" autocomplete="new-password"
                        onChange=${event => this.setState({passwordAgain: event.target.value})} />
                    <div class="error-message">${this.state.message}</div>
                    <button>Зарегистрироваться</button>
                </form>
            `;
            }
        }

        class ReportView extends Component {
            constructor(props) {
                super(props);
                this.state = {};
            }

            fetchReport() {
                if (this._app.state.reports) {
                    console.log(this._app.state.reports, this.props.reportId);
                    let report = this._app.state.reports.find(report => report.id === this.props.reportId);
                    if (report) {
                        this.setState({responseWithReport: {success: true, report}});
                        return;
                    }
                }

                get("/api/report/" + this.props.reportId)
                .then(responseWithReport => {
                    if (!responseWithReport)
                        return;

                    this.setState({responseWithReport});
                });
            }

            render() {
                this._app = useContext(AppContext).app;
                if (!this.state.responseWithReport)
                    this.fetchReport();

                let response = this.state.responseWithReport;
                if (!response)
                    return html``;
                if (this.state.responseWithReport.success) {
                    let report = this.state.responseWithReport.report;
                    return html`
                        <div class="report">
                            <samp>${new Date(report.datetime).toLocaleString()}</samp>
                            <samp>${report.fileName}</samp>
                            <div class="checks">
                                ${report.checks.map(check => {
                                    let checkName = html([check.name.replace(/"(.*)"/g, '<span class=fragment>$1</span>')]);
                                    return html`
                                        <div class="check">
                                            <div class=${check.success ? "success-sign" : "fail-sign"} />
                                            <div>${checkName}</div>
                                        </div>
                                    `;
                                })}
                            </div>
                        </div>
                    `;
                }
                else
                    return html`<div class="banner">${this.state.responseWithReport.message}</div>`;
            }
        }

        class App extends Component {
            constructor(props) {
                super(props);

                this.state = {
                    location: window.location.pathname,
                    login: localStorage.login,
                    authToken: localStorage.authToken,
                }

                window.addEventListener("popstate", () => this.setState({location: window.location.pathname}));
            }

            isSignIn() {
                return localStorage.login;
            }

            rememberSignIn(login, authToken) {
                localStorage.login = login;
                localStorage.authToken = authToken;
                this.setState({login, authToken});
            }
            sighOut() {
                delete localStorage.login;
                delete localStorage.authToken;
                this.setState({login: undefined, authToken: undefined, reports: undefined});
            }

            relocate(path) {
                window.history.pushState(path, '', path);
                this.setState({location: path});
            }

            fetchReports() {
                if (!this.isSignIn())
                    return;
                get('/api/reports')
                .then(result => {
                    if (!result || !result.success)
                        return;
                    this.setState({reports: result.reports});
                })
            }

            render() {
                let contentElement = null;
                let contentOnLocations = {
                    '/sign-in': SignInPage,
                    '/sign-up': SignUpPage,
                    '/report/(?<reportId>[0-9a-zA-Z]+)': ReportView,
                    '/': MainPageContent,
                }
                for (let location in contentOnLocations) {
                    let locationMatch = this.state.location.match(location);
                    if (locationMatch) {
                        contentElement = html`<${contentOnLocations[location]} ...${locationMatch.groups} />`;
                        break;
                    }
                }

                return html`
                    <${AppContext.Provider} value=${{app: this}}>
                        <div id="header">
                            <div id="logo" onClick=${() => this.relocate('/')}>ETU presentation checker</div>
                            <${UserControls} userName=${this.state.login}/>
                        </div>
                        <div id="content">${contentElement}</div>
                    <//>
                `;
            }
        }

        let app = html`<${App} />`;
        render(app, document.body);
    </script>
</head>
<body>
</body>
</html>